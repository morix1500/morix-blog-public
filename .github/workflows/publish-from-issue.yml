name: Publish blog post from issue

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  publish:
    if: github.event.label.name == 'publish' && github.event.sender.login == 'morix1500'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install tcardgen
        run: go install github.com/Ladicle/tcardgen@latest

      - name: Create blog post
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # æ—¥ä»˜ã‚’å–å¾—
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)

          # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
          SLUG="post-${ISSUE_NUMBER}"

          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          DIR="content/posts/${YEAR}/${MONTH}/${DAY}"
          mkdir -p "$DIR"

          FILEPATH="${DIR}/${SLUG}.md"

          # Issueæœ¬æ–‡ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã®front matterã¨æœ¬æ–‡ã‚’æŠ½å‡ºã—ã¦ä¿å­˜
          echo "$ISSUE_BODY" | sed -n '/^```yaml$/,/^```$/p' | sed '1d;$d' > "$FILEPATH"
          echo "" >> "$FILEPATH"
          echo "$ISSUE_BODY" | sed -n '/^```$/,$ p' | sed '1d' >> "$FILEPATH"

          echo "POST_PATH=${FILEPATH}" >> $GITHUB_ENV
          echo "SLUG=${SLUG}" >> $GITHUB_ENV

      - name: Generate OGP image
        run: |
          tcardgen \
            -f assets/fonts \
            -o static/ogp \
            -t assets/template.png \
            -c assets/tcardgen.yaml \
            "${{ env.POST_PATH }}"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/posts/ static/ogp/
          git commit -m "Add new post: ${{ github.event.issue.title }}

          From issue #${{ github.event.issue.number }}"
          git push

      - name: Close issue with comment
        uses: actions/github-script@v7
        with:
          script: |
            const slug = process.env.SLUG;
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ‰ è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼\n\nURL: https://morix1500.github.io/morix-blog-public/posts/${year}/${month}/${day}/${slug}/`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
